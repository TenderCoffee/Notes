# 同步的原理

在不同的客户端中表现相同



## 状态同步 - 服务器跑逻辑 客户端是播放器 - 视野范围内的结果状态信息广播给客户端 - 随时进出战斗（MMO）

![](.\images\网络同步_状态同步.png)

**服务器计算操作的结果，再将结果下发到客户端去表现**



1、A将释放技能去攻击B 的操作请求 发送到 服务器

2、服务器有所有客户端的全量的数据（位置、血量），服务器进行计算，检测当前这一次攻击给哪些角色造成伤害

​	如果B 角色在 A 角色 攻击范围内，并且状态是可受到攻击的，服务器会将B 的血量减少，然后把状态标记为受到伤害，最后把运算出来的**结果状态信息**，广播给所有的客户端，客户端在收到这些状态信息后，更新角色的状态信息（血量），播放技能命中的效果



优点：

​	1、安全 - 逻辑运行在服务器，修改会被服务器校正

​	2、可以随时在战斗的过程中进出，新加入战斗的角色**只需要获取到当前时间点里视野范围里的所有的状态数据**就可以（**MMO游戏中的副本地图**），这也让断线重连的恢复很容易	

缺点：

​	下发的数据比较复杂 - 服务器要运行大量的计算逻辑





### 状态同步的实时对战

客户端只是一个播放器，播放的是服务器的运算结果

如果视野范围内没有角色发生操作，没有东西发生变化，服务器不需要下发数据到客户端

只有产生变化时，才需要通知客户端做表现上的更新





## 帧同步 - 客户端跑逻辑 服务器做转发 - 玩家数量固定 服务器有所有操作的序列帧 可校验作弊（Moba）- 定点数、可靠UDP 逻辑与显示分离、运动平滑插值、服务器逻辑帧率每秒15帧

![](.\images\网络同步_帧同步.png)

**服务器转发操作，各自客户端中独立运算操作的结果**



1、A将释放技能去攻击B 的操作请求 发送到 服务器

2、服务器广播请求到所有的客户端

3、所有客户端收到请求后，将A这个角色释放技能，并且检测这个技能是否能够击中B

​	如果B 角色在 A 角色 攻击范围内，并且状态是可受到攻击的，这时候 B的血量减少，各自在各自的客户端中运算进行减少血量的操作，并且播放相应的命中效果



特点：

​	服务器只是转发操作、可以承载更多的人数 - 服务器不处理具体计算逻辑

缺点：

​	1、服务器没有计算的部分由客户端计算，并且要保证所有的客户端的计算的结果都是相同的

​	2、不同的平台 计算浮点数 有差异，累积起来的浮点数差异会导致不同步（浮点数 用 定点数 替换计算）

​	3、因为所有的逻辑运行在客户端中，战斗过程中不允许有其他玩家新加入，适合玩家数量固定的游戏（moba、RTS 类型的游戏），玩家掉线，退出游戏后，也只能从服务器中获取到所有操作的序列帧，然后从头开始计算一遍，通过加速逻辑帧的运行恢复战斗

​	4、因为服务器上有所有操作的序列帧，所以可以实现战斗重放，数据量很小，服务器也可以用这个序列帧进行校验是否作弊



### 帧同步需要做的准备

1、浮点数 要转换为 **定点数** 才能参与计算

因为逻辑运行在客户端中，客户端有不同的操作系统和CPU型号，计算时要解决浮点数差异

2、**人物角色移动、物理碰撞 需要自己实现**

Unity 自身是建立在 浮点数的运算，不能使用 Unity 自带的角色控制 和 物理相关的组件



### 帧同步的实时对战

#### 1、高频率的网络通信 - 可靠UDP

​	TCP 协议无法满足需求，需要实现 **可靠UDP** 通信

​	假如为了体验流畅，设置为 每秒100帧，但无法实现，因为网络通信无法接受这样频率

​	需要开发基于KCP 的可靠UDP 通信：

​		1、拥有 UDP 比 TCP 快的特性

​		2、解决 UDP 丢包不可靠



#### 2、逻辑与显示分离

​	逻辑运算不依赖于 Unity引擎

​	逻辑与显示分离：

​	为什么需要分离：逻辑帧的帧速率只有15帧，这个帧率对客户端的显示非常卡顿

​	在所有的客户端中，游戏逻辑层 是 按照 15帧 的帧率逻辑运算，显示层面上每个玩家的手机能跑多快就多快

​	整个逻辑层不依赖于Unity引擎，抽出代码可以运行在服务器上做战斗校验防作弊 = 运行在控制台的客户端

​	注意：逻辑层 不能引入 任何显示层 的数据来做计算，显示层 要根据 逻辑层的数据 来做校正

​	逻辑层 的开发 与 Unity 没有关系，显示层的开发 基于 MonoBehavior 来刷新角色的显示



#### 3、运动行为预测与插值平滑

​	逻辑帧速率不能直接用于显示层表现

​	因为逻辑与显示分离，显示层 要做运动行为的 预测 + 表现平滑

​	显示使用逻辑的帧率会出现 跳跃，为了解决卡顿，需要计算插值平滑运动轨迹，并且在逻辑帧的间隔里做适当的运动行为预测，不能完全按照逻辑帧的数据做显示



#### 4、服务器逻辑帧率：每秒15帧、1帧 = 66ms

帧循环 需要统一逻辑帧率 驱动 游戏：

玩家A 在 第100帧 中血量减少，其他客户端也必须保证在 第100帧 中血量减少，这样所有的客户端才能在 第101逻辑帧 中数据完全相同

客户端运行了完整的逻辑，随着游戏一直更新向前走，游戏角色B 在 游戏角色A  视野范围玩，释放了全图大招，即使视野范围看不到，也必须每帧计算位置变化，因为每个客户端需要进行完整的逻辑计算

帧同步中**不能使用 Update 驱动游戏逻辑**，因为每个客户端的手机性能有差异，两边帧速率不一样，算出来的结果也有差异。

逻辑帧由 服务器 驱动（通常让服务器按照 **每秒15帧** 的频率下发到客户端），需要高频率的网络通信（可靠UDP）



服务器不停收集客户端输入操作，每过66ms，就把66ms里面所搜集的操作数据广播给所有的客户端，客户端再进行各自逻辑运算，就算没有客户端的操作数据，服务器也需要广播**空的数据帧**去驱动客户端的逻辑运行



假如因为大部分时间没有操作，为了节省服务器资源而降帧（5帧每秒），则 一帧之间的间隔 是 200ms

如果释放闪现技能，发操作技能到服务器，服务器在收到操作的时候，前面刚刚已经发过上一次广播的数据，则需要等到200ms 才能发送下一次数据到客户端中，发到服务器需要时间（假设为10ms），而下发到客户端中又需要时间（假设为 10ms），累加起来延迟=220ms，无法满足实时对战的游戏

















